/**
 * Google Apps Script Backend for Investment Tracker Web App
 * Author: Gemini
 * Version: 2.0 (Includes DELETE and UPDATE functionality)
 * This script handles all data operations (GET, POST) for the Investment Tracker frontend.
 */

// --- Global Configuration ---
const SS = SpreadsheetApp.getActiveSpreadsheet();
const CURRENCY_SHEET = SS.getSheetByName("Currency");
const STOCKS_SHEET = SS.getSheetByName("Stocks");
const DIVIDENDS_SHEET = SS.getSheetByName("Dividends");
const SHEETS = {
  currency: CURRENCY_SHEET,
  stock: STOCKS_SHEET,
  dividend: DIVIDENDS_SHEET
};


// --- Main Handlers for Web App ---

function doGet(e) {
  try {
    const action = e.parameter.action || 'getAllData';

    if (action === 'getAllData') {
      const currencyData = getSheetData(CURRENCY_SHEET);
      const stockData = getSheetData(STOCKS_SHEET);
      const dividendData = getSheetData(DIVIDENDS_SHEET);
      const summary = calculateSummary(currencyData, stockData, dividendData);

      const responseData = {
        summary: summary,
        currency: currencyData,
        stocks: stockData,
        dividends: dividendData
      };
      
      return createJsonResponse(responseData);
    }
    
    return createJsonResponse({ status: "error", message: "Invalid action" }, 400);

  } catch (error) {
    return createJsonResponse({ status: "error", message: error.message }, 500);
  }
}


function doPost(e) {
  try {
    const action = e.parameter.action;
    const payloadString = e.parameter.payload;

    if (!action || !payloadString) {
      throw new Error("Invalid request: 'action' and 'payload' parameters are required.");
    }
    
    const payload = JSON.parse(payloadString);
    let result;

    switch (action) {
      case 'addCurrency':
        result = addCurrencyRecord(payload);
        break;
      case 'addStock':
        result = addStockRecord(payload);
        break;
      case 'addDividend':
        result = addDividendRecord(payload);
        break;
      case 'deleteRecord':
        result = deleteRecordById(payload.type, payload.id);
        break;
      case 'updateRecord':
         result = updateRecordById(payload.type, payload.id, payload.data);
         break;
      default:
        throw new Error(`Action '${action}' not recognized.`);
    }

    return ContentService.createTextOutput("Success: " + JSON.stringify(result));

  } catch (error) {
    console.error("doPost Error:", error.message, error.stack);
    return ContentService.createTextOutput("Error: " + error.message);
  }
}


// --- Data Writing Functions ---

function addCurrencyRecord(data) {
  const { thbAmount, exchangeRate } = data;
  const usdAmount = parseFloat(thbAmount) / parseFloat(exchangeRate);
  const newRow = [Utilities.getUuid(), new Date(), parseFloat(thbAmount), parseFloat(exchangeRate), usdAmount];
  CURRENCY_SHEET.appendRow(newRow);
  return { id: newRow[0], message: "Currency record added." };
}

function addStockRecord(data) {
  const { stockName, purchasePrice, vatPurchase, salePrice, vatSale } = data;
  const profitLoss = parseFloat(salePrice) - parseFloat(purchasePrice) - parseFloat(vatSale);
  const newRow = [Utilities.getUuid(), new Date(), stockName, parseFloat(purchasePrice), parseFloat(vatPurchase), parseFloat(salePrice), parseFloat(vatSale), profitLoss];
  STOCKS_SHEET.appendRow(newRow);
  return { id: newRow[0], message: "Stock record added." };
}

function addDividendRecord(data) {
    const { stockName, dividendAmount, taxAmount } = data;
    const netDividend = parseFloat(dividendAmount) - parseFloat(taxAmount);
    const newRow = [Utilities.getUuid(), new Date(), stockName, parseFloat(dividendAmount), parseFloat(taxAmount), netDividend];
    DIVIDENDS_SHEET.appendRow(newRow);
    return { id: newRow[0], message: "Dividend record added." };
}

// --- Data Deletion and Update Functions ---

function findRowById(sheet, id) {
  if (!sheet) return -1;
  const data = sheet.getRange("A:A").getValues();
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] == id) {
      return i + 1; // Return 1-based row index
    }
  }
  return -1;
}

function deleteRecordById(type, id) {
  const sheet = SHEETS[type];
  if (!sheet) throw new Error("Invalid record type for deletion.");
  
  const row = findRowById(sheet, id);
  if (row !== -1) {
    sheet.deleteRow(row);
    return { status: "success", message: `Record ${id} deleted from ${type}` };
  }
  throw new Error(`Record with ID ${id} not found in ${type}.`);
}

function updateRecordById(type, id, data) {
    const sheet = SHEETS[type];
    if (!sheet) throw new Error("Invalid record type for update.");

    const row = findRowById(sheet, id);
    if (row === -1) throw new Error(`Record with ID ${id} not found.`);

    let valuesToUpdate = [];
    switch(type) {
        case 'currency':
            const usdAmount = parseFloat(data.thbAmount) / parseFloat(data.exchangeRate);
            // Assuming columns are ID, Timestamp, THB_Amount, Exchange_Rate, USD_Amount
            valuesToUpdate = [id, sheet.getRange(row, 2).getValue(), parseFloat(data.thbAmount), parseFloat(data.exchangeRate), usdAmount];
            break;
        case 'stock':
            const profitLoss = parseFloat(data.salePrice) - parseFloat(data.purchasePrice) - parseFloat(data.vatSale);
            // Assuming columns are ID, Timestamp, Stock_Name, Purchase_Price_USD, VAT_Purchase_USD, Sale_Price_USD, VAT_Sale_USD, Profit_Loss_USD
            valuesToUpdate = [id, sheet.getRange(row, 2).getValue(), data.stockName, parseFloat(data.purchasePrice), parseFloat(data.vatPurchase), parseFloat(data.salePrice), parseFloat(data.vatSale), profitLoss];
            break;
        case 'dividend':
            const netDividend = parseFloat(data.dividendAmount) - parseFloat(data.taxAmount);
            // Assuming columns are ID, Timestamp, Stock_Name, Dividend_Amount, Tax_Amount, Net_Dividend
            valuesToUpdate = [id, sheet.getRange(row, 2).getValue(), data.stockName, parseFloat(data.dividendAmount), parseFloat(data.taxAmount), netDividend];
            break;
    }
    
    if (valuesToUpdate.length > 0) {
        sheet.getRange(row, 1, 1, valuesToUpdate.length).setValues([valuesToUpdate]);
        return { status: "success", message: `Record ${id} updated in ${type}` };
    }
    throw new Error("No values to update.");
}


// --- Data Reading and Calculation Functions ---

function getSheetData(sheet) {
  if (!sheet || sheet.getLastRow() < 2) return [];
  const range = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn());
  const values = range.getValues();
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  return values.map(row => {
    let obj = {};
    headers.forEach((header, i) => {
      obj[header] = row[i];
    });
    return obj;
  });
}

function calculateSummary(currencyData, stockData, dividendData) {
    const summary = {realizedProfit: 0, realizedLoss: 0, totalDividend: 0, netPL: 0, initialCapitalUSD: 0, initialCapitalTHB: 0, avgRate: 0, totalVatPurchase: 0, totalVatSale: 0, totalDividendTax: 0,};
    currencyData.forEach(row => { summary.initialCapitalTHB += row.THB_Amount || 0; summary.initialCapitalUSD += row.USD_Amount || 0; });
    if (summary.initialCapitalUSD > 0) { summary.avgRate = summary.initialCapitalTHB / summary.initialCapitalUSD; }
    stockData.forEach(row => { const pl = row.Profit_Loss_USD || 0; if (pl > 0) { summary.realizedProfit += pl; } else { summary.realizedLoss += pl; } summary.totalVatPurchase += row.VAT_Purchase_USD || 0; summary.totalVatSale += row.VAT_Sale_USD || 0; });
    dividendData.forEach(row => { summary.totalDividend += row.Net_Dividend || 0; summary.totalDividendTax += row.Tax_Amount || 0; });
    summary.netPL = summary.realizedProfit + summary.realizedLoss + summary.totalDividend;
    return summary;
}


// --- Utility Functions ---

function createJsonResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
