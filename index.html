<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMCRO</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#ffffff"/>
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/mm12346/ZZ/refs/heads/main/991.jpg">
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter & Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Sarabun', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .nav-btn {
            transition: all 0.2s ease-in-out;
        }
        .nav-btn.active {
            color: #2563eb; /* blue-600 */
        }
        .nav-btn:not(.active) {
            color: #6b7280; /* gray-500 */
        }
        .profit { color: #16a34a; } /* green-600 */
        .loss { color: #dc2626; } /* red-600 */
        #loader, #modal-backdrop {
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 pb-24">

    <!-- Fullscreen Loader -->
    <div id="loader" class="fixed inset-0 bg-white/50 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
    </div>
    
    <!-- Edit Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/40 z-40 hidden"></div>
    <div id="edit-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-2xl shadow-lg w-11/12 max-w-lg z-50 hidden">
        <h2 id="modal-title" class="text-xl font-bold mb-4 text-gray-700">แก้ไขรายการ</h2>
        <div id="modal-form-content">
            <!-- Dynamic form content will be injected here -->
        </div>
        <div class="mt-6 flex gap-4">
            <button id="modal-cancel-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors">ยกเลิก</button>
            <button id="modal-update-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">อัปเดต</button>
        </div>
    </div>


    <main class="max-w-4xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 id="header-title" class="text-3xl md:text-4xl font-bold text-gray-800">สรุป</h1>
        </header>

        <!-- Tab Content -->
        <div id="tab-content">
            
            <!-- ================================== -->
            <!--    Summary Module      -->
            <!-- ================================== -->
            <div id="summary-module">
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm"><h2 class="text-xl font-bold mb-4 text-gray-700">ประเมินมูลค่าปัจจุบัน</h2><div class="flex flex-col md:flex-row gap-4 items-end mb-6"><div class="w-full md:w-1/2"><label for="current-rate" class="block text-sm font-medium text-gray-600 mb-1">อัตราแลกเปลี่ยนปัจจุบัน (THB/USD)</label><input type="number" id="current-rate" step="0.01" class="w-full px-4 py-2 bg-gray-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="เช่น 36.80"></div><button id="btn-fetch-rate" class="w-full md:w-auto px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">ดึงเรทล่าสุด</button></div><p id="api-limit-message" class="text-sm text-center text-gray-500 mb-4 hidden"></p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center"><div class="bg-blue-50 p-4 rounded-lg"><h3 class="font-semibold text-blue-600 text-sm">มูลค่าพอร์ต (USD)</h3><div class="flex items-baseline justify-center gap-2 mt-1"><p id="summary-total-value-usd" class="text-2xl font-bold text-blue-800">0.00</p><span id="summary-total-return-percent" class="text-lg font-bold text-gray-800">(0.00%)</span></div></div><div class="bg-indigo-50 p-4 rounded-lg"><h3 class="font-semibold text-indigo-600 text-sm">มูลค่าพอร์ต (บาท)</h3><p id="summary-total-value-thb" class="text-2xl font-bold text-indigo-800 mt-1">0.00</p></div></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm"><h2 class="text-xl font-bold mb-4 text-gray-700">ผลตอบแทนรวม (ที่เกิดขึ้นจริง)</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center"><div><h3 class="font-semibold text-gray-500 text-sm">กำไรรวม</h3><p id="summary-realized-profit" class="text-2xl font-bold profit mt-1">0.00</p></div><div><h3 class="font-semibold text-gray-500 text-sm">ขาดทุนรวม</h3><p id="summary-realized-loss" class="text-2xl font-bold loss mt-1">0.00</p></div><div><h3 class="font-semibold text-gray-500 text-sm">ปันผลรวม</h3><p id="summary-total-dividend" class="text-2xl font-bold profit mt-1">0.00</p></div><div class="bg-gray-100 p-2 rounded-lg"><h3 class="font-semibold text-gray-500 text-sm">สุทธิ (USD)</h3><p id="summary-net-pl" class="text-2xl font-bold text-gray-800 mt-1">0.00</p></div></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm"><h2 class="text-xl font-bold mb-4 text-gray-700">ภาพรวมต้นทุน</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center"><div><h3 class="font-semibold text-gray-500 text-sm">ต้นทุน (USD)</h3><p id="summary-initial-capital" class="text-2xl font-bold text-gray-800 mt-1">0.00</p></div><div><h3 class="font-semibold text-gray-500 text-sm">ต้นทุน (บาท)</h3><p id="summary-initial-capital-thb" class="text-2xl font-bold text-gray-800 mt-1">0</p></div><div><h3 class="font-semibold text-gray-500 text-sm">เรทเฉลี่ย</h3><p id="summary-avg-rate" class="text-2xl font-bold text-gray-800 mt-1">0.00</p></div></div></div>
                </div>
            </div>

            <div id="currency-module" class="hidden"><!-- Currency Module Content --></div>
            <div id="stock-module" class="hidden"><!-- Stock Module Content --></div>
            <div id="dividend-module" class="hidden"><!-- Dividend Module Content --></div>
        </div>
    </main>

    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-white/80 backdrop-blur-sm border-t border-gray-200">
        <div class="max-w-4xl mx-auto h-full grid grid-cols-4 gap-1">
            <button id="nav-btn-summary" data-title="สรุป" class="nav-btn flex flex-col items-center justify-center gap-1 active">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span class="text-xs font-semibold">สรุป</span>
            </button>
            <button id="nav-btn-currency" data-title="แลกเปลี่ยนเงิน" class="nav-btn flex flex-col items-center justify-center gap-1">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                <span class="text-xs font-semibold">แลกเงิน</span>
            </button>
            <button id="nav-btn-stock" data-title="บันทึกหุ้น" class="nav-btn flex flex-col items-center justify-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                <span class="text-xs font-semibold">หุ้น</span>
            </button>
            <button id="nav-btn-dividend" data-title="บันทึกปันผล" class="nav-btn flex flex-col items-center justify-center gap-1">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                <span class="text-xs font-semibold">ปันผล</span>
            </button>
        </div>
    </nav>

    <script>
        // --- PWA SETUP ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        
        // --- CONFIGURATION ---
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyFI6zP3B2sghH5yofM25jyEKCtMoGOwOzthv8x8KPMEE7L8cH0JI42sDEXW91-1HI0yw/exec';

        // --- GLOBAL STATE ---
        const appState = {
            summary: {},
            currency: [],
            stocks: [],
            dividends: [],
            isLoading: false,
            editMode: { active: false, type: null, id: null },
        };

        // --- DOM ELEMENTS ---
        let DOM = {};

        function cacheDOMElements() {
            DOM.navContainer = document.querySelector('nav');
            DOM.headerTitle = document.getElementById('header-title');
            DOM.loader = document.getElementById('loader');
            DOM.allModules = {
                summary: document.getElementById('summary-module'),
                currency: document.getElementById('currency-module'),
                stock: document.getElementById('stock-module'),
                dividend: document.getElementById('dividend-module')
            };
            DOM.currentRateInput = document.getElementById('current-rate');
            DOM.modal = document.getElementById('edit-modal');
            DOM.modalBackdrop = document.getElementById('modal-backdrop');
            DOM.fetchRateBtn = document.getElementById('btn-fetch-rate');
            DOM.apiLimitMessage = document.getElementById('api-limit-message');
        }

        
        // --- RENDERING FUNCTIONS ---
        function renderAll() {
            renderCurrencyModule();
            renderStockModule();
            renderDividendModule();
            updateSummaryView(); // Use the new comprehensive summary function
        }

        function updateSummaryView() {
            if (!appState.summary || !appState.stocks || !appState.dividends) {
                return; // Data not ready
            }

            const stocks = appState.stocks || [];
            const dividends = appState.dividends || [];
            const backendSummary = appState.summary;

            // Recalculate P/L from raw stock data
            const { realizedProfit, realizedLoss } = stocks.reduce((acc, stock) => {
                const pnl = (stock.Sale_Price_USD || 0) - (stock.Purchase_Price_USD || 0);
                if (pnl >= 0) {
                    acc.realizedProfit += pnl;
                } else {
                    acc.realizedLoss += pnl;
                }
                return acc;
            }, { realizedProfit: 0, realizedLoss: 0 });

            // Recalculate total dividend from raw dividend data
            const totalDividend = dividends.reduce((acc, div) => acc + (div.Dividend_Amount || 0), 0);
            
            const netPL = realizedProfit + realizedLoss + totalDividend;
            
            // Use capital figures from the backend summary
            const initialCapitalUSD = backendSummary.initialCapitalUSD || 0;
            const initialCapitalTHB = backendSummary.initialCapitalTHB || 0;
            const avgRate = backendSummary.avgRate || 0;
            
            const formatCurrency = (value, fractionDigits = 2) => (value || 0).toLocaleString('en-US', { minimumFractionDigits: fractionDigits, maximumFractionDigits: fractionDigits });

            // --- Update Summary DOM ---
            document.getElementById('summary-realized-profit').textContent = `+${formatCurrency(realizedProfit)}`;
            document.getElementById('summary-realized-loss').textContent = `${formatCurrency(realizedLoss)}`;
            document.getElementById('summary-total-dividend').textContent = `+${formatCurrency(totalDividend)}`;
            document.getElementById('summary-net-pl').textContent = formatCurrency(netPL);
            document.getElementById('summary-initial-capital').textContent = formatCurrency(initialCapitalUSD);
            document.getElementById('summary-initial-capital-thb').textContent = (initialCapitalTHB).toLocaleString('en-US', { maximumFractionDigits: 0 });
            document.getElementById('summary-avg-rate').textContent = formatCurrency(avgRate);
            
            document.getElementById('summary-net-pl').classList.toggle('profit', netPL > 0);
            document.getElementById('summary-net-pl').classList.toggle('loss', netPL < 0);
            
            // --- Update Portfolio Value DOM ---
            const currentRate = parseFloat(DOM.currentRateInput.value) || 0;
            const portfolioValueUSD = initialCapitalUSD + netPL;

            document.getElementById('summary-total-value-usd').textContent = portfolioValueUSD.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('summary-total-value-thb').textContent = (currentRate > 0) ? (portfolioValueUSD * currentRate).toLocaleString('en-US', {minimumFractionDigits: 2}) : '0.00';
            
            const percentageReturn = (initialCapitalUSD > 0) ? (netPL / initialCapitalUSD) * 100 : 0;
            const percentDisplay = document.getElementById('summary-total-return-percent');
            percentDisplay.textContent = `(${percentageReturn.toFixed(2)}%)`;
            percentDisplay.className = 'text-lg font-bold';
            if (percentageReturn > 0) percentDisplay.classList.add('profit');
            else if (percentageReturn < 0) percentDisplay.classList.add('loss');
            else percentDisplay.classList.add('text-gray-800');
        }

        function renderCurrencyModule() {
            const content = `<div class="bg-white p-6 rounded-2xl shadow-sm mb-6"><h2 class="text-xl font-bold mb-4 text-gray-700">บันทึกการแลกเงิน (THB to USD)</h2><div class="grid md:grid-cols-2 gap-4"><div><label for="thb-amount" class="block text-sm font-medium text-gray-600 mb-1">จำนวนเงิน (บาท)</label><input type="number" id="thb-amount" class="w-full px-4 py-2 bg-gray-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น 36500"></div><div><label for="exchange-rate" class="block text-sm font-medium text-gray-600 mb-1">อัตราแลกเปลี่ยน (THB/USD)</label><input type="number" id="exchange-rate" step="0.01" class="w-full px-4 py-2 bg-gray-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น 36.50"></div></div><div class="mt-4 bg-blue-50 p-4 rounded-lg text-blue-800"><p class="flex justify-between items-center"><span>จะได้รับ USD:</span> <strong id="usd-result" class="text-lg">0.00</strong></p></div><button id="save-currency" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">บันทึกรายการ</button></div><div><h3 class="text-lg font-bold mb-3 text-gray-700">ประวัติการแลกเปลี่ยน</h3><div class="overflow-x-auto bg-white rounded-2xl shadow-sm"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-600 uppercase"><tr><th class="p-4">วันที่</th><th class="p-4">THB</th><th class="p-4">เรท</th><th class="p-4">USD</th><th class="p-4 text-center">จัดการ</th></tr></thead><tbody id="currency-history-table"></tbody></table></div></div>`;
            DOM.allModules.currency.innerHTML = content;
            const tableBody = DOM.allModules.currency.querySelector('#currency-history-table');
            tableBody.innerHTML = (appState.currency || []).slice().reverse().map(row => `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="p-4">${new Date(row.Timestamp).toLocaleDateString('th-TH')}</td>
                    <td class="p-4">${(row.THB_Amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="p-4">${(row.Exchange_Rate || 0).toFixed(2)}</td>
                    <td class="p-4 font-semibold">${(row.USD_Amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="p-4 text-center">
                         <button onclick="editRecord('currency', '${row.ID}')" class="text-yellow-500 hover:text-yellow-700 mr-2 text-sm">แก้ไข</button>
                         <button onclick="deleteRecord('currency', '${row.ID}')" class="text-red-500 hover:text-red-700 text-sm">ลบ</button>
                    </td>
                </tr>
            `).join('') || `<tr><td colspan="5" class="text-center p-4 text-gray-500">ไม่มีข้อมูล</td></tr>`;
            
            DOM.allModules.currency.querySelector('#save-currency').addEventListener('click', saveCurrency);
            const thbInput = DOM.allModules.currency.querySelector('#thb-amount');
            const rateInput = DOM.allModules.currency.querySelector('#exchange-rate');
            const usdResult = DOM.allModules.currency.querySelector('#usd-result');
            const calc = () => {
                const thb = parseFloat(thbInput.value) || 0;
                const rate = parseFloat(rateInput.value) || 0;
                usdResult.textContent = rate > 0 ? (thb / rate).toLocaleString('en-US', {minimumFractionDigits: 2}) : '0.00';
            };
            if(thbInput) thbInput.addEventListener('input', calc);
            if(rateInput) rateInput.addEventListener('input', calc);
        }

        function renderStockModule() {
            const content = `<div class="bg-white p-6 rounded-2xl shadow-sm mb-6"><h2 class="text-xl font-bold mb-4 text-gray-700">บันทึกการซื้อ-ขายหุ้น</h2><div class="space-y-4"><div class="mb-4"><label for="stock-name" class="block text-sm font-medium text-gray-600 mb-1">ชื่อหุ้น (Symbol)</label><input type="text" id="stock-name" class="w-full px-4 py-2 bg-gray-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="เช่น GOOGL, TSLA"></div><div><label for="purchase-price" class="block text-sm font-medium text-gray-600 mb-1">ราคาซื้อรวม (USD)</label><input type="number" id="purchase-price" class="w-full px-4 py-2 bg-gray-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="1000"></div><div><label for="sale-price" class="block text-sm font-medium text-gray-600 mb-1">ราคาขายรวม (USD)</label><input type="number" id="sale-price" class="w-full px-4 py-2 bg-gray-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="1200"></div></div><button id="save-stock" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors">บันทึกรายการซื้อขาย</button></div><div><h3 class="text-lg font-bold mb-3 text-gray-700">ประวัติการซื้อขาย</h3><div class="overflow-x-auto bg-white rounded-2xl shadow-sm"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-600 uppercase"><tr><th class="p-4">ชื่อหุ้น</th><th class="p-4">ราคาซื้อ</th><th class="p-4">ราคาขาย</th><th class="p-4">กำไร/ขาดทุน</th><th class="p-4 text-center">จัดการ</th></tr></thead><tbody id="stock-history-table"></tbody></table></div></div>`;
            DOM.allModules.stock.innerHTML = content;
            const tableBody = DOM.allModules.stock.querySelector('#stock-history-table');
            tableBody.innerHTML = (appState.stocks || []).slice().reverse().map(row => {
                const purchasePrice = row.Purchase_Price_USD || 0;
                const salePrice = row.Sale_Price_USD || 0;
                const profitLoss = salePrice - purchasePrice;
                return `
                 <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="p-4 font-semibold">${row.Stock_Name}</td>
                    <td class="p-4">${purchasePrice.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="p-4">${salePrice.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="p-4 font-bold ${profitLoss >= 0 ? 'profit' : 'loss'}">${profitLoss.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td class="p-4 text-center">
                         <button onclick="editRecord('stock', '${row.ID}')" class="text-yellow-500 hover:text-yellow-700 mr-2 text-sm">แก้ไข</button>
                         <button onclick="deleteRecord('stock', '${row.ID}')" class="text-red-500 hover:text-red-700 text-sm">ลบ</button>
                    </td>
                </tr>
            `}).join('') || `<tr><td colspan="5" class="text-center p-4 text-gray-500">ไม่มีข้อมูล</td></tr>`;
            DOM.allModules.stock.querySelector('#save-stock').addEventListener('click', saveStock);
        }

        function renderDividendModule() {
            const content = `<div class="bg-white p-6 rounded-2xl shadow-sm mb-6"><h2 class="text-xl font-bold mb-4 text-gray-700">บันทึกเงินปันผล</h2><div class="space-y-4"><div class="mb-4"><label for="div-stock-name" class="block text-sm font-medium text-gray-600 mb-1">ชื่อหุ้น (Symbol)</label><input type="text" id="div-stock-name" class="w-full px-4 py-2 bg-gray-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="เช่น AAPL, PTT"></div><div><label for="dividend-amount" class="block text-sm font-medium text-gray-600 mb-1">ปันผลที่ได้รับ (USD)</label><input type="number" id="dividend-amount" class="w-full px-4 py-2 bg-gray-100 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="100"></div></div><button id="save-dividend" class="mt-6 w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors">บันทึกเงินปันผล</button></div><div><h3 class="text-lg font-bold mb-3 text-gray-700">ประวัติเงินปันผล</h3><div class="overflow-x-auto bg-white rounded-2xl shadow-sm"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-600 uppercase"><tr><th class="p-4">ชื่อหุ้น</th><th class="p-4">ปันผลที่ได้รับ (USD)</th><th class="p-4 text-center">จัดการ</th></tr></thead><tbody id="dividend-history-table"></tbody></table></div></div>`;
            DOM.allModules.dividend.innerHTML = content;
            const tableBody = DOM.allModules.dividend.querySelector('#dividend-history-table');
            tableBody.innerHTML = (appState.dividends || []).slice().reverse().map(row => `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="p-4 font-semibold">${row.Stock_Name}</td>
                    <td class="p-4 font-bold profit">${(row.Dividend_Amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                     <td class="p-4 text-center">
                         <button onclick="editRecord('dividend', '${row.ID}')" class="text-yellow-500 hover:text-yellow-700 mr-2 text-sm">แก้ไข</button>
                         <button onclick="deleteRecord('dividend', '${row.ID}')" class="text-red-500 hover:text-red-700 text-sm">ลบ</button>
                    </td>
                </tr>
            `).join('') || `<tr><td colspan="3" class="text-center p-4 text-gray-500">ไม่มีข้อมูล</td></tr>`;
            
            DOM.allModules.dividend.querySelector('#save-dividend').addEventListener('click', saveDividend);
        }


        // --- DATA HANDLING ---
        function setLoading(isLoading) {
            appState.isLoading = isLoading;
            DOM.loader.classList.toggle('hidden', !isLoading);
        }

        async function postData(action, payload) {
            setLoading(true);
            try {
                const form = new FormData();
                form.append('action', action);
                form.append('payload', JSON.stringify(payload));
                
                await fetch(BACKEND_URL, {
                    method: 'POST',
                    body: form,
                    mode: 'no-cors' 
                });
                
            } catch (error) {
                 console.warn('POST request sent. A CORS error is expected and can be ignored if data is saved correctly.', error);
            } finally {
                setTimeout(() => {
                    init();
                }, 2500);
            }
        }
        
        function deleteRecord(type, id) {
             if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?`)) {
                 postData('deleteRecord', { type, id });
             }
        }

        function editRecord(type, id) {
            const dataSetKeyMap = { currency: 'currency', stock: 'stocks', dividend: 'dividends' };
            const dataSetKey = dataSetKeyMap[type];
            const dataSet = appState[dataSetKey];

            if (!dataSet) {
                console.error(`Dataset for type "${type}" is not found.`);
                return;
            };
            const record = dataSet.find(item => String(item.ID) === String(id));
            if (!record) {
                console.error(`Record with ID "${id}" not found in dataset for type "${type}".`);
                return;
            };

            appState.editMode = { active: true, type, id };
            openEditModal(type, record);
        }

        // --- MODAL FUNCTIONS ---
        function openEditModal(type, record) {
            const formContent = document.getElementById('modal-form-content');
            let formHtml = '';

            switch (type) {
                case 'currency':
                    formHtml = `
                        <div class="space-y-4">
                            <div><label class="block text-sm">จำนวนเงิน (บาท)</label><input type="number" id="edit-thb-amount" value="${record.THB_Amount}" class="w-full mt-1 p-2 bg-gray-100 rounded-lg"></div>
                            <div><label class="block text-sm">อัตราแลกเปลี่ยน</label><input type="number" step="0.01" id="edit-exchange-rate" value="${record.Exchange_Rate}" class="w-full mt-1 p-2 bg-gray-100 rounded-lg"></div>
                        </div>`;
                    break;
                case 'stock':
                    formHtml = `
                        <div class="space-y-4">
                            <div><label class="block text-sm">ชื่อหุ้น</label><input type="text" id="edit-stock-name" value="${record.Stock_Name}" class="w-full mt-1 p-2 bg-gray-100 rounded-lg"></div>
                            <div><label class="block text-sm">ราคาซื้อรวม (USD)</label><input type="number" id="edit-purchase-price" value="${record.Purchase_Price_USD}" class="w-full mt-1 p-2 bg-gray-100 rounded-lg"></div>
                            <div><label class="block text-sm">ราคาขายรวม (USD)</label><input type="number" id="edit-sale-price" value="${record.Sale_Price_USD}" class="w-full mt-1 p-2 bg-gray-100 rounded-lg"></div>
                        </div>`;
                    break;
                case 'dividend':
                    formHtml = `
                         <div class="space-y-4">
                             <div><label class="block text-sm">ชื่อหุ้น</label><input type="text" id="edit-div-stock-name" value="${record.Stock_Name}" class="w-full mt-1 p-2 bg-gray-100 rounded-lg"></div>
                             <div><label class="block text-sm">ปันผลที่ได้รับ (USD)</label><input type="number" id="edit-dividend-amount" value="${record.Dividend_Amount}" class="w-full mt-1 p-2 bg-gray-100 rounded-lg"></div>
                         </div>`;
                    break;
            }
            formContent.innerHTML = formHtml;
            
            DOM.modal.classList.remove('hidden');
            DOM.modalBackdrop.classList.remove('hidden');
        }

        function closeEditModal() {
            appState.editMode = { active: false, type: null, id: null };
            DOM.modal.classList.add('hidden');
            DOM.modalBackdrop.classList.add('hidden');
        }

        function handleUpdate() {
            const { type, id } = appState.editMode;
            if (!type || !id) return;
            
            let data = {};
            switch(type) {
                case 'currency':
                    data = {
                        thbAmount: document.getElementById('edit-thb-amount').value,
                        exchangeRate: document.getElementById('edit-exchange-rate').value,
                    };
                    break;
                case 'stock':
                    data = {
                        stockName: document.getElementById('edit-stock-name').value,
                        purchasePrice: document.getElementById('edit-purchase-price').value,
                        salePrice: document.getElementById('edit-sale-price').value,
                    };
                    break;
                case 'dividend':
                    data = {
                        stockName: document.getElementById('edit-div-stock-name').value,
                        dividendAmount: document.getElementById('edit-dividend-amount').value,
                    };
                    break;
            }

            postData('updateRecord', { type, id, data });
            closeEditModal();
        }

        function saveCurrency() {
            const thbAmount = parseFloat(DOM.allModules.currency.querySelector('#thb-amount').value);
            const exchangeRate = parseFloat(DOM.allModules.currency.querySelector('#exchange-rate').value);
            if (!thbAmount || !exchangeRate || thbAmount <= 0 || exchangeRate <= 0) {
                alert('กรุณากรอกข้อมูลการแลกเงินให้ถูกต้อง');
                return;
            }
            postData('addCurrency', { thbAmount, exchangeRate });
            DOM.allModules.currency.querySelector('#thb-amount').value = '';
            DOM.allModules.currency.querySelector('#exchange-rate').value = '';
        }

        function saveStock() {
            const payload = {
                stockName: DOM.allModules.stock.querySelector('#stock-name').value,
                purchasePrice: parseFloat(DOM.allModules.stock.querySelector('#purchase-price').value) || 0,
                salePrice: parseFloat(DOM.allModules.stock.querySelector('#sale-price').value) || 0,
            };
            if (!payload.stockName || !payload.purchasePrice || !payload.salePrice) {
                alert('กรุณากรอกชื่อหุ้น, ราคาซื้อ, และราคาขาย');
                return;
            }
            postData('addStock', payload);
            DOM.allModules.stock.querySelector('#stock-name').value = '';
            DOM.allModules.stock.querySelector('#purchase-price').value = '';
            DOM.allModules.stock.querySelector('#sale-price').value = '';
        }

        function saveDividend() {
            const payload = {
                stockName: DOM.allModules.dividend.querySelector('#div-stock-name').value,
                dividendAmount: parseFloat(DOM.allModules.dividend.querySelector('#dividend-amount').value) || 0,
            };
            if (!payload.stockName || !payload.dividendAmount) {
                alert('กรุณากรอกชื่อหุ้นและจำนวนปันผล');
                return;
            }
            postData('addDividend', payload);
            DOM.allModules.dividend.querySelector('#div-stock-name').value = '';
            DOM.allModules.dividend.querySelector('#dividend-amount').value = '';
        }


        // --- NAVIGATION ---
        function setActiveTab(button) {
            const allNavButtons = document.querySelectorAll('.nav-btn');
            allNavButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            const targetModuleId = button.id.replace('nav-btn-', '');
            DOM.headerTitle.textContent = button.dataset.title;

            Object.values(DOM.allModules).forEach(mod => mod.classList.add('hidden'));
            DOM.allModules[targetModuleId].classList.remove('hidden');
        }

        // --- Exchange Rate API ---
        const EXCHANGE_RATE_API_KEY = '2b50f0188f18dbe19a515559';
        const EXCHANGE_RATE_API_URL = `https://v6.exchangerate-api.com/v6/${EXCHANGE_RATE_API_KEY}/latest/USD`;
        const DAILY_LIMIT = 32;

        function checkApiLimit() {
            const today = new Date().toISOString().split('T')[0];
            let apiUsage = JSON.parse(localStorage.getItem('apiUsage')) || { date: today, count: 0 };
            
            if (apiUsage.date !== today) {
                apiUsage = { date: today, count: 0 };
            }
            localStorage.setItem('apiUsage', JSON.stringify(apiUsage));
            
            if (apiUsage.count >= DAILY_LIMIT) {
                DOM.fetchRateBtn.disabled = true;
                DOM.apiLimitMessage.textContent = `คุณใช้โควต้าดึงข้อมูลสำหรับวันนี้ครบแล้ว (${apiUsage.count}/${DAILY_LIMIT})`;
                DOM.apiLimitMessage.classList.remove('hidden');
                return false;
            }
            
            DOM.fetchRateBtn.disabled = false;
            DOM.apiLimitMessage.textContent = `โควต้าคงเหลือ: ${DAILY_LIMIT - apiUsage.count}/${DAILY_LIMIT}`;
            DOM.apiLimitMessage.classList.remove('hidden');
            return true;
        }

        async function fetchExchangeRate() {
            if (!checkApiLimit()) return;
            
            setLoading(true);
            DOM.fetchRateBtn.textContent = 'กำลังดึง...';
            DOM.fetchRateBtn.disabled = true;

            try {
                const response = await fetch(EXCHANGE_RATE_API_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                if (data.result === 'success' && data.conversion_rates.THB) {
                    const rate = data.conversion_rates.THB;
                    DOM.currentRateInput.value = rate.toFixed(4);
                    const event = new Event('input', { bubbles: true });
                    DOM.currentRateInput.dispatchEvent(event);
                    
                    let apiUsage = JSON.parse(localStorage.getItem('apiUsage'));
                    apiUsage.count++;
                    localStorage.setItem('apiUsage', JSON.stringify(apiUsage));
                } else {
                    DOM.apiLimitMessage.textContent = 'ไม่สามารถดึงข้อมูลเรทได้';
                }
            } catch (error) {
                console.error('Fetch error:', error);
                DOM.apiLimitMessage.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ';
            } finally {
                setLoading(false);
                DOM.fetchRateBtn.textContent = 'ดึงเรทล่าสุด';
                checkApiLimit();
            }
        }

        // --- INITIALIZATION ---
        async function init() {
            setLoading(true);
            try {
                const response = await fetch(`${BACKEND_URL}?action=getAllData&t=${new Date().getTime()}`);
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                const data = await response.json();
                appState.summary = data.summary;
                appState.currency = data.currency;
                appState.stocks = data.stocks;
                appState.dividends = data.dividends;

                // Set the initial value for the exchange rate input to the average rate
                if (appState.summary && appState.summary.avgRate) {
                    DOM.currentRateInput.value = parseFloat(appState.summary.avgRate).toFixed(4);
                }
                
                renderAll();
            } catch (error) {
                console.error('Initialization failed:', error);
                alert('ไม่สามารถโหลดข้อมูลเริ่มต้นได้ กรุณาตรวจสอบว่า Deploy Apps Script เป็น "ทุกคน" และลองรีเฟรชหน้า');
            } finally {
                setLoading(false);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            cacheDOMElements();
            setActiveTab(document.querySelector('.nav-btn.active'));
            checkApiLimit();
            init();

            // Attach static event listeners here
            DOM.navContainer.addEventListener('click', (event) => {
                const button = event.target.closest('.nav-btn');
                if (button) {
                    setActiveTab(button);
                }
            });
            DOM.currentRateInput.addEventListener('input', updateSummaryView);
            DOM.fetchRateBtn.addEventListener('click', fetchExchangeRate);
            document.getElementById('modal-cancel-btn').addEventListener('click', closeEditModal);
            document.getElementById('modal-update-btn').addEventListener('click', handleUpdate);
        });
    </script>
</body>
</html>

